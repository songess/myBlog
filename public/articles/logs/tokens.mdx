---
id: tokens
title: 토큰처리
date: 2025-01-06
---

티그에서 토큰을 어떻게 처리할지 고민하고 있다.

# 기존 처리방식
사용자가 로그인을 하면 인가코드가 클라리언트에 오고, 이걸 백엔드로 보내 인증을 마친 이후 RT는 쿠키에, AT는 응답의 바디에 담아온걸 받아 로컬스토리지에 저장한다.

## 왜 이렇게?
로컬스토리지에 토큰을 저장하면 브라우저에서 접근이 가능하기 때문에 XSS공격에 취약할 수 있다.
처음에는 AT, RT를 모두 쿠키에 담아서 보내왔는데, 우리 사이트는 `samesite=none;`를 사용했고 `secure; http-only;`를 부여해야 했기 때문에 브라우저에서 쿠키를 읽을 수 없었다.

`samesite=none;`을 사용한 이유는, `lax`는 POST등 특정 메서드에 쿠키가 담기지 않고, `strict`는 크로스사이트 가 불가능해서 개발환경이 너무 불편하였기 때문에 `none`을 선택했다.

그러다보니 현재 서비스에서 일어나는 비효율 방식은

1. 사용자가 로그인했는지/안했는지 확인하기 위해선 브라우저단에 와서야 확인이 가능하고 이후 리다이렉션이 이루어진다.
  - 이에 따라 속도가 느려짐
2. 로그인 유저/비로그인 유저의 요청을 모두 보내고 토큰 여부를 확인해 필요한 요청을 골라쓴다.
  - 트래픽 소모가 심하다

# 생각해보고 시도해본 해결책

## lax를 그대로 쓰고 붙이면 안되나?
`lax`의 문제점은 특정 요청들에 대해 토큰이 담기지 않는다는 것이다. 그럼, 미들웨어를 통해 그러한 요청들을 찾아내 토큰을 추가하면 안되나?

-> 불가능했다. 미들웨어는 `보내지는 요청`에 대한 가공을 할 수 있다. 새로운 쿠키를 `set`으로 추가할 수 있지만 그게 브라우저가 보내지 않은 쿠키를 찾아서 보낼 수 있다는 것과는 다르다.

즉 브라우저가 보내지 않은 토큰에 대해서는 미들웨어에서는 확인할 수 없기 때문에 이 방법은 불가능했다.

## 미들웨어에서 토큰여부를 확인해서 로그인/비로그인 유저를 구분할 순 없나?
next.js의 미들웨어는 웹서버이기 때문에 `http-only` 속성이 있더라도 `NextRequest`, `NextResponse`를 사용하면 RT, AT를 확인할 수 있지 않을까 했지만 두 개의 문제가 있었다.

1. 모든 요청이 미들웨어를 거치지 않는다.
- 미들웨어를 거치는 것(도메인)은 개발서버기준 `https://localhost:3000`이다. 따라서 `api.tig..com`등으로 보내는 요청은 미들웨어에 잡히지 않기 때문에 분기처리를 할 수 없었다.
2. 쿠키가 보내질 도메인은 마음대로 정할 수 업다.
- 쿠키의 `domain`값은 상위 도메인으로 한정되어 있다. 개발서버와 배포서버의 도메인은 다르기 때문에, 미들웨어에 대한 요청은 쿠키가 담기지 않는다.

### 쿠키를 응답의 헤더에서 받아서 내가 쿠키에 등록하는 방법은?
가능은 했다. 하지만 브라우저단에서 쿠키를 등록하는 방식은 `http-only`를 붙일 수 없기 때문에 결국 로컬스토리지에 등록하는 방식과 다를 바 없었다.

### 미들웨어 단에서 하는게 아니라 서버컴포넌트 단에서 수행할 수는 없나?
이는 미들웨어 단에서 수행하는 로직과 다를 바 없었다. 여기서 `cookieStore`를 통해 요청에 사용되는 쿠키를 사용하는게 가능했지만 백엔드 서버로 보낼때 담기는 쿠키에 대해서는 확인할 수 없었다.

# 그래서 어떻게 해결할 수 있을까?
백엔드에서 개발서버용 쿠키를 사용하거나 백엔드와 프론트의 배포서버 도메인을 맞춘다면 가능해 보이나, 이 방법은 딱히 좋아보이지 않는다.

<br/> 현재 방식으로도 로직을 변경하면, 배포서버에서는 정상적으로 수행이 가능할 것 같다.

지금 문제가 되는 것은 `localhost:3000`에 대한 요청에 쿠키가 담기지 않는다는 것인데, 배포서버를 사용하면 동일한 도메인을 사용할 것이기 때문에 쿠키가 담겨 내가 원하는 대로 수행할 수 있을 것이다.

이 방법 말고 개발/배포서버에서 정상적으로 확인할 수 있는 방법이 있을까?